suite: test if the resource settings for metallb controller in cluster are correct
release:
  name: metallb
templates:
- charts/metallb/templates/controller.yaml
values:
- ../values-subchart-overrides.yaml
tests:
- it: snapshot test for detecting side effects on all local metallb controllers during local development
  asserts:
  - matchSnapshot: {}
  values: &localValues
  - ../values-local.yaml
- it: snapshot test for detecting side effects on all dev metallb controllers during local development
  asserts:
  - matchSnapshot: {}
  values: &devValues
  - ../values-development.yaml
- it: snapshot test for detecting side effects on all prod metallb controllers during local development
  asserts:
  - matchSnapshot: {}
  values: &prodValues
  - ../values-production.yaml
- it: metallb controller container resources for local cluster
  values: *localValues
  asserts:
  - matchRegex:
      path: &cpuLimitsPath spec.template.spec.containers[?(@.name == "controller")].resources.limits.cpu
      # on local cluster we expect 0 or 0m cpu limits
      pattern: &localCpuPattern "^0(m)?$"
  - matchRegex:
      path: &memoryLimitsPath spec.template.spec.containers[?(@.name == "controller")].resources.limits.memory
      # on local cluster we expect non 0 memory limits
      pattern: &nonZeroMemoryPattern "^[1-9][0-9]*(Ki|Mi|Gi)?$"
  - matchRegex:
      path: &requestsCpuPath spec.template.spec.containers[?(@.name == "controller")].resources.requests.cpu
      # on local cluster we expect 0 or 0m cpu requests
      pattern: *localCpuPattern
  - matchRegex:
      path: &requestsMemoryPath spec.template.spec.containers[?(@.name == "controller")].resources.requests.memory
      # on local cluster we expect 0 or 0Mi 0Gi memory requests
      pattern: "^0(Ki|Mi|Gi)?$"

- it: metallb controller container resources for dev-cloud01 cluster
  values: *devValues
  asserts: &externalSecretsResourcesAsserts
  - matchRegex:
      path: *cpuLimitsPath
      # on non local cluster we expect >= 1m cpu limits
      pattern: &cpuPattern "^[1-9][0-9]*(m)?$"
  - matchRegex:
      path: *memoryLimitsPath
      # on non local cluster we expect non 0 memory limits
      pattern: *nonZeroMemoryPattern
  - matchRegex:
      path: *requestsCpuPath
      # on non local cluster we expect  >= 1m cpu requests
      pattern: *cpuPattern
  - matchRegex:
      path: *requestsMemoryPath
      # on non local cluster we expect non 0 memory requests
      pattern: *nonZeroMemoryPattern

- it: metallb controller container resources for prod-cloud01 cluster
  values: *prodValues
  asserts: *externalSecretsResourcesAsserts
